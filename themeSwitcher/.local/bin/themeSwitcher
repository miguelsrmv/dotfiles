#!/bin/bash

# Exit on errors, undefined variables, and pipeline failures
set -euo pipefail

# Setup directory paths
DATA_DIR="$HOME/.local/share/themeSwitcher"
SCRIPT_DIR="$DATA_DIR/scripts"
THEME_DIR="$DATA_DIR/themes"
DOTFILES_DIR="$HOME/.dotfiles"

# Get theme list
source "$SCRIPT_DIR/get_theme_list.sh"

# Get desktop environment
source "$SCRIPT_DIR/get_desktop_environment.sh"

# Get calling app
source "$SCRIPT_DIR/get_caller.sh"

# Only run interactive selection if called from a terminal
if [ "$CALLER" = "Terminal" ]; then
	# Ask user to select theme and convert to kebab case
    THEME=$(printf "%s\n" "${THEME_NAMES[@]}" \
      | fzf \
			--prompt="Choose your theme: " \
			--reverse \
      | tr '[:upper:]' '[:lower:]' \
      | sed 's/ /-/g')
else
	echo "Non-interactive launcher detected: skipping theme selection."
fi

# Apply selected theme
if [ -n "${THEME:-}" ]; then
	source "$SCRIPT_DIR/apply_ghostty_theme.sh"
	source "$SCRIPT_DIR/apply_tmux_theme.sh"
	source "$SCRIPT_DIR/apply_starship_theme.sh"
	source "$SCRIPT_DIR/apply_nvim_theme.sh"
	source "$SCRIPT_DIR/apply_btop_theme.sh"
	
	if [ "$DESKTOP_ENVIRONMENT" == "GNOME" ]; then
		source "$SCRIPT_DIR/apply_gnome_theme.sh"
	elif [ "$DESKTOP_ENVIRONMENT" == "Hyprland" ]; then
		source "$SCRIPT_DIR/apply_hyprland_theme.sh"
	fi
fi

# Write current theme name for bg switching
echo "$THEME" > "$DATA_DIR/current_theme.txt"
